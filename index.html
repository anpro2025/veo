<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AN PRODUCTION AI FILMS - STORY BROAD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Đồng bộ khoảng cách các icon sidebar */
        #collapsible-sidebar .memory-btn,
        #collapsible-sidebar a.w-full,
        #collapsible-sidebar li > button,
        #collapsible-sidebar li > a {
            padding-top: 4px !important;
            padding-bottom: 4px !important;
            padding-left: 8px !important;
            padding-right: 8px !important;
            margin-bottom: 0.5px !important;
            margin-top: 0.5px !important;
        }
        /* Nền xanh dương cho cụm bộ nhớ, icon trắng */
        .sidebar-group-blue {
            background: #2563eb;
            border-radius: 12px;
            margin: 8px 0;
            padding: 4px 0;
        }
        .sidebar-group-blue .sidebar-icon-blue {
            color: #fff !important;
        }
        /* Nền vàng cho cụm đầu vào, icon trắng */
        .sidebar-group-yellow {
            background: #facc15;
            border-radius: 12px;
            margin: 8px 0;
            padding: 4px 0;
        }
        .sidebar-group-yellow .sidebar-icon-yellow {
            color: #fff !important;
        }
        /* Nền xanh lá cho cụm P2S, icon trắng */
        .sidebar-group-yellow {
            background: #facc15;
            border-radius: 12px;
            margin: 2px 0 !important;
            padding: 4px 0;
        }
        .sidebar-group-blue {
            background: #2563eb;
            border-radius: 12px;
            margin: 2px 0 !important;
            padding: 4px 0;
        }
        .sidebar-group-green {
            background: #22c55e;
            border-radius: 12px;
            margin: 2px 0 !important;
            padding: 4px 0;
        }
        #collapsible-sidebar .sidebar-text {
            display: none !important;
        }
        /* Thu hẹp sidebar */
        #collapsible-sidebar {
            min-width: 56px;
            width: 56px;
            max-width: 56px;
        }
        /* Ẩn scrollbar cho các phần tử con trong sidebar */
        #collapsible-sidebar .flex-grow,
        #collapsible-sidebar .overflow-y-auto {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        #collapsible-sidebar .flex-grow::-webkit-scrollbar,
        #collapsible-sidebar .overflow-y-auto::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none !important;
        }
        .script-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .script-item.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .delete-btn {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .script-item:hover .delete-btn {
            visibility: visible;
            opacity: 1;
        }
        /* Loading spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Ẩn hoàn toàn scrollbar ở sidebar */
        #collapsible-sidebar::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
        }
        #collapsible-sidebar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        /* Transitions for containers */
        .workspace-column, #memory-list-column, #memory-editor-panel {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }
        
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        /* Make textareas non-resizable and take full height */
        textarea {
            resize: none;
        }
        textarea:read-only, input:read-only {
            background-color: #374151; /* gray-700 */
            cursor: default;
        }
        .memory-count {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: white;
            color: #1f2937;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: bold;
            line-height: 1;
            padding: 2px 5px;
            min-width: 18px;
            text-align: center;
            border: 2px solid #374151;
        }
        .image-loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Sidebar styles */
        #collapsible-sidebar .sidebar-text {
            white-space: nowrap;
        }
         #collapsible-sidebar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="flex h-screen bg-gray-900 text-white">
    <!-- Collapsible Sidebar -->
    <aside id="collapsible-sidebar" class="bg-gray-800 flex flex-col p-2 transition-all duration-300 z-40 h-full">
        <div class="flex-grow flex flex-col space-y-4 overflow-y-auto">
        <div class="flex-grow flex flex-col overflow-y-auto">
            <ul class="space-y-2">
                <li><button id="api-key-btn" title="Cài đặt" class="w-full flex justify-center items-center p-2 space-x-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 1.996A1.532 1.532 0 013.17 8.51c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 1.996 1.57A1.532 1.532 0 018.51 16.83c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734-1.57-1.996A1.532 1.532 0 0116.83 11.49c1.56-.38-1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-1.996-1.57A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg><span class="sidebar-text text-sm">Cài đặt</span></button></li>
            </ul>
            <!-- Main Actions moved to horizontal bar -->

            <div class="border-t border-gray-700 my-2"></div>
            
            <!-- Nút đặt lại bộ nhớ -->
            <div class="flex justify-center mb-2">
                <button id="reset-memory-btn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-full text-sm w-auto" title="Làm mới giao diện">F5</button>
            </div>
            <ul class="space-y-2">
                <div class="sidebar-group-yellow">
                    <li><button data-type="script" title="Đầu vào Ý tưởng" class="memory-btn w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="text-sm font-bold w-5 text-center flex-shrink-0 text-black">I</span><span class="sidebar-text text-sm">Ý tưởng</span></button></li>
                    <li><button data-type="prompt" title="Đầu vào Se" class="memory-btn w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="text-sm font-bold w-5 text-center flex-shrink-0 text-black">Se</span><span class="sidebar-text text-sm">Section</span></button></li>
                    <li><button data-type="voiceOver" title="Đầu vào VO" class="memory-btn w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="text-sm font-bold w-5 text-center flex-shrink-0 text-black">VO</span><span class="sidebar-text text-sm">Voice Over</span></button></li>
                    <li><button data-type="scenes" title="Bối cảnh" class="memory-btn relative w-full flex justify-center items-center p-2 space-x-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21V10m0 0a8.001 8.001 0 00-8-8h0a8.001 8.001 0 008 8zm0 0a8.001 8.001 0 018-8h0a8.001 8.001 0 01-8 8z" /></svg><span class="sidebar-text text-sm">Bối cảnh</span><span class="memory-count hidden ml-auto"></span></button></li>
                    <li><button data-type="characters" title="Nhân vật" class="memory-btn relative w-full flex justify-center items-center p-2 space-x-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span class="sidebar-text text-sm">Nhân vật</span><span class="memory-count hidden ml-auto"></span></button></li>
                </div>
            </ul>
             <div class="border-t border-gray-700 my-2"></div>

            <ul class="space-y-2">
                <div class="sidebar-group-blue">
                    <li><button data-type="mainScripts" title="Bộ nhớ Scripts" class="memory-btn relative w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="text-sm font-bold w-5 text-center flex-shrink-0 sidebar-icon-blue">S</span><span class="sidebar-text text-sm">Scripts</span><span class="memory-count hidden ml-auto"></span></button></li>
                    <li><button data-type="sections" title="Bộ nhớ Sections" class="memory-btn relative w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="text-sm font-bold w-5 text-center flex-shrink-0 sidebar-icon-blue">Se</span><span class="sidebar-text text-sm">Sections</span><span class="memory-count hidden ml-auto"></span></button></li>
                    <li><button data-type="mainPrompts" title="Bộ nhớ Prompts" class="memory-btn relative w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="text-sm font-bold w-5 text-center flex-shrink-0 sidebar-icon-blue">P</span><span class="sidebar-text text-sm">Prompts</span><span class="memory-count hidden ml-auto"></span></button></li>
                    <li><button data-type="mainVoiceOvers" title="Bộ nhớ Voice Off" class="memory-btn relative w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="text-sm font-bold w-5 text-center flex-shrink-0 sidebar-icon-blue">VO</span><span class="sidebar-text text-sm">Voice Off</span><span class="memory-count hidden ml-auto"></span></button></li>
                    <li><button data-type="trash" title="Bộ nhớ Rác" class="memory-btn relative w-full flex justify-center items-center p-2 space-x-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 sidebar-icon-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg><span class="sidebar-text text-sm">Thùng rác</span><span class="memory-count hidden ml-auto"></span></button></li>
                </div>
            </ul
             <div class="border-t border-gray-700 my-2"></div>

             <ul class="space-y-2">
                 <div class="border-t border-gray-700 my-2"></div>
                 <!-- Cụm P2S, S2Se, Prompt Studio với nền xanh lá -->
                 <div class="sidebar-group-green">
                    <li><a href="#" id="create-script-btn" title="Idea to Script" class="w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="font-bold w-7 h-7 flex items-center justify-center sidebar-icon-green" style="font-size:0.95rem;">I2S</span><span class="sidebar-text text-sm">Idea to Script</span></a></li>
                    <li><a href="https://anproduction2025.github.io/ancontents/S2Se" title="S2Se (Script to Section)" class="w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="font-bold w-7 h-7 flex items-center justify-center sidebar-icon-green" style="font-size:0.95rem;">S2Se</span><span class="sidebar-text text-sm">S2Se</span></a></li>
                    <li><a href="/ancontents/Prompts-Studio/" title="Prompt Studio" class="w-full flex justify-center items-center p-2 space-x-2 rounded-full"><span class="font-bold w-7 h-7 flex items-center justify-center sidebar-icon-green" style="font-size:0.95rem;">Ps</span><span class="sidebar-text text-sm">Prompt Studio</span></a></li>
                 </div>
                 <div class="border-t border-gray-700 my-2"></div>
                 <!-- Các cụm còn lại -->
                 <li><a href="/ancontents/thu-vien/" title="Thư viện Prompts" class="w-full flex justify-center items-center p-2 space-x-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0014.5 16c1.255 0 2.443-.29 3.5.804v-10A7.968 7.968 0 0014.5 4z" /></svg><span class="sidebar-text text-sm">Thư viện Prompts</span></a></li>
                 <li><button id="open-image-studio-btn" title="Image Studio" class="w-full flex justify-center items-center p-2 space-x-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="sidebar-text text-sm">Image Studio</span></button></li>
                 <li><a href="/ancontents/text-to-voice/" title="Tạo Voice (TTS)" class="w-full flex justify-center items-center p-2 space-x-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg><span class="sidebar-text text-sm">Tạo Voice (TTS)</span></a></li>
             </ul>
        </div>
        <!-- Bottom section -->
        <div class="mt-auto">
           <!-- Đã xóa nút cài đặt dưới cùng -->
        </div>
    </aside>

    <div class="flex-grow flex flex-col overflow-hidden">
        <!-- Xóa header tiêu đề AN PRODUCTION AI FILMS - STORY BROAD -->
        
        <!-- Đã xóa thanh ngang navigation bar -->
        
        <!-- Đã xóa thanh taskbar ngang trên cùng -->
        
        <main class="flex-grow p-8 flex space-x-8 overflow-x-auto relative">
            <!-- Initial Input Column -->
            <div id="script-form-container" class="workspace-column hidden w-[400px] flex-shrink-0 bg-gray-800 p-6 rounded-lg">
                <!-- Đã xóa tiêu đề Nhập đầu vào -->
                <form id="script-form" class="space-y-4">
                    <div>
                        <label for="script-idea" class="block text-sm font-medium text-gray-300">Ý tưởng kịch bản / Tóm tắt (Tùy chọn)</label>
                        <textarea id="script-idea" rows="4" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500"></textarea>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="script-input-script" class="block text-sm font-medium text-yellow-400">Chọn Ý Tưởng và Dự Án</label>
                            <select id="script-input-script" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500"></select>
                        </div>
                        <div>
                            <label for="script-input-voice" class="block text-sm font-medium text-yellow-400">Chọn hướng dẫn Voice Off</label>
                            <select id="script-input-voice" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500"></select>
                        </div>
                        <div>
                            <label for="script-style" class="block text-sm font-medium text-gray-300">Phong cách (Tùy chọn)</label>
                            <select id="script-style" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <option value="">Mặc định</option>
                                <option>Storytelling</option><option>Hài hước</option><option>Chính kịch</option><option>Hành động</option><option>Kinh dị</option><option>Kịch câm</option>
                            </select>
                        </div>
                        <div>
                            <label for="script-duration" class="block text-sm font-medium text-gray-300">Thời lượng</label>
                             <select id="script-duration" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <option value="1">1 phút</option><option value="10">10 phút</option><option value="60">60 phút</option><option value="custom">Tùy chỉnh...</option>
                            </select>
                            <input type="number" id="script-duration-custom" placeholder="Nhập số phút" class="hidden mt-2 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                         <div>
                            <label for="word-limit" class="block text-sm font-medium text-gray-300">Giới hạn số từ (Tùy chọn)</label>
                            <input type="number" id="word-limit" placeholder="Ví dụ: 500" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                        </div>
                        <!-- New Toggles -->
                        <div class="flex items-center justify-between pt-2">
                            <label for="character-prompt-toggle" class="text-sm font-medium text-gray-300">Tạo Prompt Nhân vật</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="character-prompt-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-green-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="scene-prompt-toggle" class="text-sm font-medium text-gray-300">Tạo Prompt Bối cảnh</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="scene-prompt-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-green-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Đóng</button>
                        <button type="submit" id="generate-script-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md min-w-[80px] flex justify-center items-center">
                            <span class="btn-text">Tạo</span><span class="loader hidden ml-2"></span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Result Window Wrappers -->
            <div id="script-window-wrapper" class="flex-1"></div>
            <div id="vo-window-wrapper" class="flex-1"></div>
            <div id="characterPrompts-window-wrapper" class="flex-1"></div>
            <div id="scenePrompts-window-wrapper" class="flex-1"></div>
             <div id="imageGenerator-window-wrapper" class="flex-1"></div>
        </main>
        
    </div>
    
    <!-- Generic Memory Modal -->
    <div id="memory-modal-container" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg relative w-full max-w-[95vw] h-[95vh] flex flex-col shadow-2xl">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <h2 id="memory-modal-title" class="text-2xl font-bold mb-6 flex-shrink-0">Bộ nhớ</h2>
            <div class="flex space-x-6 flex-grow overflow-hidden">
                <!-- List -->
                <div id="memory-list-column" class="w-1/6 border-r border-gray-700 pr-2 flex flex-col">
                    <div class="flex-shrink-0 flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Danh sách</h3>
                        <div class="flex items-center space-x-2">
                            <button type="button" id="delete-all-memory-btn" title="Xóa tất cả" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-full transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <button type="button" id="delete-all-trash-btn" title="Xóa tất cả trong rác" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-full transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                             <button type="button" id="toggle-list-btn" title="Thu gọn danh sách" class="text-gray-400 hover:text-white p-2 rounded-full">
                                <!-- SVG icon will be added by JS -->
                            </button>
                            <button id="memory-new-item-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></button>
                        </div>
                    </div>
                    <div id="memory-modal-list" class="space-y-2 overflow-y-auto flex-grow"></div>
                </div>
                <!-- Editor -->
                <div id="memory-editor-panel" class="w-3/4 hidden flex flex-col">
                    <form id="memory-modal-form" class="space-y-4 flex flex-col flex-grow">
                        <input type="hidden" id="memory-modal-id">
                        <div class="flex-shrink-0">
                            <label for="memory-modal-title-input" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                            <input type="text" id="memory-modal-title-input" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                        <div class="flex-grow flex flex-col min-h-0">
                             <div class="flex justify-between items-center flex-shrink-0">
                                <label for="memory-modal-content-input" class="block text-sm font-medium text-gray-300">Nội dung</label>
                                <span id="memory-word-count" class="text-xs text-gray-400">0 từ</span>
                            </div>
                            <textarea id="memory-modal-content-input" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 flex-grow"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2 flex-shrink-0">
                            <button type="button" id="memory-edit-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md">Chỉnh sửa</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                            <button type="button" id="memory-copy-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Copy</button>
                            <button type="button" id="memory-export-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Xuất TXT</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-container" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full relative shadow-2xl">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <h2 class="text-2xl font-bold mb-6">Cài đặt</h2>
            <form id="api-key-form" class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-300">API Key của bạn <a href="https://aistudio.google.com/api-keys" target="_blank" class="text-blue-400 hover:underline text-xs ml-2">(Lấy API Key tại đây)</a></label>
                    <div class="relative mt-1">
                        <input type="password" id="api-key-input" placeholder="Dán API Key của bạn vào đây..." class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 pr-10">
                        <button type="button" id="toggle-api-key-visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white"></button>
                    </div>
                </div>
                <div>
                    <label for="ai-model-select" class="block text-sm font-medium text-gray-300">Model AI mặc định</label>
                    <select id="ai-model-select" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                        <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash</option>
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Mới nhất)</option>
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Mới nhất)</option>
                        <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold py-2 px-4 rounded-md">Lưu Cài đặt</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modals -->
    <div id="delete-confirm-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
        <div class="bg-gray-700 rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Xác nhận xóa</h2>
            <p id="delete-confirm-message" class="text-gray-300 mb-6">Bạn có chắc chắn muốn xóa mục này không? Mục này sẽ được chuyển vào Thùng rác.</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Hủy</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md">Xóa</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 left-5 z-[100] space-y-2"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const createScriptBtn = document.getElementById('create-script-btn');
            const scriptFormContainer = document.getElementById('script-form-container');
            if (createScriptBtn && scriptFormContainer) {
                createScriptBtn.addEventListener('click', () => {
                    scriptFormContainer.classList.remove('hidden');
                });
            }
        });
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const createScriptBtn = document.getElementById('create-script-btn');
            const scriptFormContainer = document.getElementById('script-form-container');
            const mainWorkspace = document.getElementById('main-workspace');
            const scriptWindowWrapper = document.getElementById('script-window-wrapper');
            const voWindowWrapper = document.getElementById('vo-window-wrapper');
            const characterPromptsWindowWrapper = document.getElementById('characterPrompts-window-wrapper');
            const scenePromptsWindowWrapper = document.getElementById('scenePrompts-window-wrapper');
            const imageGeneratorWindowWrapper = document.getElementById('imageGenerator-window-wrapper');
            const taskbar = document.getElementById('taskbar');
            const taskbarApps = document.getElementById('taskbar-apps');
            // --- Reset Memory Button ---
            const resetMemoryBtn = document.getElementById('reset-memory-btn');

            const scriptForm = document.getElementById('script-form');
            const scriptDuration = document.getElementById('script-duration');
            const scriptDurationCustom = document.getElementById('script-duration-custom');
            
            // --- Settings Modal Elements ---
            const apiKeyBtn = document.getElementById('api-key-btn'); 
            const apiKeyContainer = document.getElementById('api-key-container');
            const apiKeyForm = document.getElementById('api-key-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
            const aiModelSelect = document.getElementById('ai-model-select');
            
            // --- Delete Modal Elements ---
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteConfirmMessage = document.getElementById('delete-confirm-message');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            
            // --- Generic Memory Modal Elements ---
            const memoryModalContainer = document.getElementById('memory-modal-container');
            const memoryModalTitle = document.getElementById('memory-modal-title');
            const memoryListColumn = document.getElementById('memory-list-column');
            const toggleListBtn = document.getElementById('toggle-list-btn');
            const deleteAllTrashBtn = document.getElementById('delete-all-trash-btn');
            const memoryModalList = document.getElementById('memory-modal-list');
            const memoryEditorPanel = document.getElementById('memory-editor-panel');
            const memoryModalForm = document.getElementById('memory-modal-form');
            const memoryModalIdInput = document.getElementById('memory-modal-id');
            const memoryModalTitleInput = document.getElementById('memory-modal-title-input');
            const memoryModalContentInput = document.getElementById('memory-modal-content-input');
            const memoryNewItemBtn = document.getElementById('memory-new-item-btn');
            const memoryEditBtn = document.getElementById('memory-edit-btn');
            const memoryCopyBtn = document.getElementById('memory-copy-btn');
            const memoryExportBtn = document.getElementById('memory-export-btn');
            const memoryWordCount = document.getElementById('memory-word-count');
            const deleteAllMemoryBtn = document.getElementById('delete-all-memory-btn');


            // --- Icons ---
            const eyeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.523 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`;
            const eyeOffIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 8.517 16.635 7.412 14.722 6.708l-1.414-1.414A10.009 10.009 0 0010 3C7.523 3 5.268 4.943 2.458 10a11.97 11.97 0 003.876 3.655l-2.227-2.228a1 1 0 00-1.414-1.414L.293 8.293a1 1 0 000 1.414l2 2a1 1 0 001.414 0l1.293-1.293A8.003 8.003 0 0110 7a8 8 0 012.828.532l1.432-1.432A9.98 9.98 0 0010 5c-2.477 0-4.732 1.943-7.542 7 .57 1.1 1.254 2.063 2.07 2.912l-1.42-1.42a1 1 0 00-1.414-1.414L.293 15.707a1 1 0 001.414 1.414l14-14a1 1 0 00-1.414-1.414L3.707 2.293z" clip-rule="evenodd" /><path d="M10.707 10.293a1 1 0 10-1.414-1.414 1 1 0 001.414 1.414z" /></svg>`;
            const collapseIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>`;
            const expandIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>`;

            const memoryConfig = {
                // Inputs
                script: { title: 'Đầu vào Ý tưởng', storageKey: 'input_scripts' },
                prompt: { title: 'Đầu vào Se', storageKey: 'input_prompts' },
                voiceOver: { title: 'Đầu vào VO', storageKey: 'input_voiceOvers' },
                // Saved Results
                mainScripts: { title: 'Bộ nhớ Scripts', storageKey: 'memory_mainScripts' },
                sections: { title: 'Bộ nhớ Sections', storageKey: 'memory_sections' },
                scenes: { title: 'Bộ nhớ Bối cảnh', storageKey: 'memory_scenes' },
                characters: { title: 'Bộ nhớ Nhân vật', storageKey: 'memory_characters' },
                mainPrompts: { title: 'Bộ nhớ Prompts', storageKey: 'memory_mainPrompts' },
                mainVoiceOvers: { title: 'Bộ nhớ Voice Off', storageKey: 'memory_mainVoiceOvers' },
                trash: { title: 'Bộ nhớ Rác', storageKey: 'memory_trash' }
            };

                // Hàm đặt lại bộ nhớ
                function resetAllMemory() {
                    Object.values(memoryConfig).forEach(cfg => {
                        localStorage.removeItem(cfg.storageKey);
                    });
                    localStorage.removeItem('anProduction_windows');
                    showToast('Đã đặt lại toàn bộ bộ nhớ. Trang sẽ được tải lại...', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1200);
                }
            
            // --- State Management ---
            const savedWindows = JSON.parse(localStorage.getItem('anProduction_windows'));

            const state = {
                // All memories loaded from localStorage
                script: JSON.parse(localStorage.getItem(memoryConfig.script.storageKey)) || [],
                prompt: JSON.parse(localStorage.getItem(memoryConfig.prompt.storageKey)) || [],
                voiceOver: JSON.parse(localStorage.getItem(memoryConfig.voiceOver.storageKey)) || [],
                mainScripts: JSON.parse(localStorage.getItem(memoryConfig.mainScripts.storageKey)) || [],
                sections: JSON.parse(localStorage.getItem(memoryConfig.sections.storageKey)) || [],
                scenes: JSON.parse(localStorage.getItem(memoryConfig.scenes.storageKey)) || [],
                characters: JSON.parse(localStorage.getItem(memoryConfig.characters.storageKey)) || [],
                mainPrompts: JSON.parse(localStorage.getItem(memoryConfig.mainPrompts.storageKey)) || [],
                mainVoiceOvers: JSON.parse(localStorage.getItem(memoryConfig.mainVoiceOvers.storageKey)) || [],
                trash: JSON.parse(localStorage.getItem(memoryConfig.trash.storageKey)) || [],
                // App settings
                settings: {
                    apiKey: localStorage.getItem('apiKey') || '',
                    aiModel: localStorage.getItem('aiModel') || 'gemini-2.5-flash-preview-05-20'
                },
                itemToDelete: null,
                isEditingMemory: false,
                currentMemoryType: null,
                windows: savedWindows || {
                    script: null,
                    vo: null,
                    characterPrompts: null,
                    scenePrompts: null,
                    imageGenerator: null
                }
            };

            // --- UI Helper Functions ---
            
            function showToast(message, type = 'info') {
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 -translate-x-full ${colors[type] || colors.info}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.remove('-translate-x-full'), 10);
                setTimeout(() => {
                    toast.classList.add('-translate-x-full');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }
            
            function setButtonLoading(button, isLoading) {
                if (!button) return;
                const btnText = button.querySelector('.btn-text');
                const loader = button.querySelector('.loader');
                button.disabled = isLoading;
                if(btnText) btnText.style.display = isLoading ? 'none' : 'inline-block';
                if(loader) loader.classList.toggle('hidden', !isLoading);
            }

            function updateWordCount(textArea, countElement) {
                if (!textArea || !countElement) return;
                const text = textArea.value.trim();
                const wordCount = text ? text.split(/\s+/).filter(Boolean).length : 0;
                countElement.textContent = `${wordCount} từ`;
            }

            function downloadAsTxt(title, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const fileName = `${(title || 'untitled').toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '_').substring(0, 50)}.txt`;
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            function formatScriptContent(content) {
                if (typeof content === 'string') {
                    return content;
                }
                if (Array.isArray(content)) {
                    return content.map(item => {
                        if (typeof item !== 'object' || item === null) {
                            return String(item);
                        }
                        return Object.entries(item).map(([key, value]) => {
                            const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                            if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                                const nestedLines = Object.entries(value)
                                    .map(([nestedKey, nestedValue]) => `    - ${nestedKey}: ${nestedValue}`)
                                    .join('\n');
                                return `${formattedKey}:\n${nestedLines}`;
                            }
                            return `${formattedKey}: ${String(value)}`;
                        }).join('\n');
                    }).join('\n\n---\n\n');
                }
                if (typeof content === 'object' && content !== null) {
                    return JSON.stringify(content, null, 2);
                }
                return String(content);
            }

            function saveUnsavedWindowsToTrash() {
                let savedSomething = false;
                ['script', 'vo'].forEach(type => {
                    const win = state.windows[type];
                     if (win && !win.saved) {
                        const title = document.getElementById(`${type}-result-title`)?.value.trim();
                        const content = document.getElementById(`${type}-result-content`)?.value.trim();
                        if (title || content) {
                            const now = new Date();
                            state.trash.push({
                                id: now.getTime() + (type === 'vo' ? 1 : 0),
                                title: `Tự động lưu (${type === 'script' ? 'Kịch bản' : 'VO'}): ${title || 'Chưa có tiêu đề'}`,
                                content: content,
                                savedAt: now.toLocaleString('vi-VN')
                            });
                            savedSomething = true;
                            win.saved = true; 
                        }
                    }
                });

                if (savedSomething) {
                    saveDataToStorage('trash');
                    showToast('Nội dung chưa lưu đã được chuyển vào Rác.');
                }
            }


            function hideMainPanels() {
                scriptFormContainer.classList.add('hidden');
            }

            function showWorkspaceColumn(element) {
                 hideMainPanels();
                 element.classList.remove('hidden');
            }

            function hideAllModals() {
                document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden'));
            }

            function saveWindowsState() {
                localStorage.setItem('anProduction_windows', JSON.stringify(state.windows));
            }

            function updateMemoryCounters() {
                Object.keys(memoryConfig).forEach(type => {
                    const button = document.querySelector(`.memory-btn[data-type="${type}"]`);
                    if (button) {
                        const countEl = button.querySelector('.memory-count');
                         if (countEl) {
                            const count = state[type]?.length || 0;
                            if (count > 0) {
                                countEl.textContent = count;
                                countEl.classList.remove('hidden');
                            } else {
                                countEl.classList.add('hidden');
                            }
                        }
                    }
                });
            }

            // --- Generic Memory Management ---

            function saveDataToStorage(type) {
                const key = memoryConfig[type]?.storageKey;
                if (key) localStorage.setItem(key, JSON.stringify(state[type]));
                updateMemoryCounters();
            }

            function renderMemoryList() {
                const type = state.currentMemoryType;
                const data = state[type] || [];
                const currentId = memoryModalIdInput.value;
                memoryModalList.innerHTML = '';
                [...data].sort((a, b) => b.id - a.id).forEach(item => {
                    const div = document.createElement('div');
                    const isTrash = type === 'trash';
                    const dateInfo = isTrash ? `<span class="text-xs text-gray-400 mt-1 block">${item.savedAt || item.deletedAt}</span>` : '';
                    div.className = `w-full text-left p-3 rounded-md transition-colors script-item cursor-pointer ${item.id == currentId ? 'active' : 'hover:bg-gray-700'}`;
                    div.dataset.id = item.id;
                    div.innerHTML = `
                        <div class="flex-grow overflow-hidden pr-2">
                           <span class="truncate pointer-events-none">${item.title}</span>
                           ${dateInfo}
                        </div>
                        <button class="delete-btn text-gray-400 hover:text-red-500 p-1 rounded-full flex-shrink-0" data-id="${item.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>`;
                    memoryModalList.appendChild(div);
                });
            }

            function updateMemoryEditorMode() {
                const isTrash = state.currentMemoryType === 'trash';
                const hasContent = !!memoryModalIdInput.value;
                const canEdit = !isTrash && hasContent;

                memoryModalTitleInput.readOnly = !state.isEditingMemory;
                memoryModalContentInput.readOnly = !state.isEditingMemory;

                memoryModalForm.querySelector('button[type="submit"]').classList.toggle('hidden', !state.isEditingMemory);
                memoryEditBtn.classList.toggle('hidden', !canEdit || state.isEditingMemory);
                memoryCopyBtn.classList.toggle('hidden', !hasContent);
                memoryExportBtn.classList.toggle('hidden', !hasContent);
            }

            function openMemoryModal(type) {
                saveUnsavedWindowsToTrash();
                hideMainPanels();
                hideAllModals();
                state.currentMemoryType = type;
                state.isEditingMemory = false;
                
                const config = memoryConfig[type];
                if (!config) return;
                memoryModalTitle.textContent = config.title;
                memoryModalContainer.classList.remove('hidden');
                memoryEditorPanel.classList.add('hidden');
                
                const isTrash = type === 'trash';
                memoryNewItemBtn.classList.toggle('hidden', isTrash);
                deleteAllTrashBtn.classList.toggle('hidden', !isTrash);
                deleteAllMemoryBtn.classList.toggle('hidden', isTrash);


                memoryListColumn.classList.remove('hidden');
                memoryEditorPanel.classList.remove('w-full', 'w-3/4');
                memoryEditorPanel.classList.add('w-3/4');
                toggleListBtn.innerHTML = collapseIconSVG;
                toggleListBtn.title = "Thu gọn danh sách";

                memoryModalForm.reset();
                memoryModalIdInput.value = '';
                updateWordCount(memoryModalContentInput, memoryWordCount);
                renderMemoryList();
                updateMemoryEditorMode();
            }

            function loadItemIntoMemoryForm(id) {
                state.isEditingMemory = false;
                const type = state.currentMemoryType;
                const item = state[type]?.find(i => i.id == id);
                if (item) {
                    memoryModalIdInput.value = item.id;
                    memoryModalTitleInput.value = item.title;
                    memoryModalContentInput.value = item.content;
                    updateWordCount(memoryModalContentInput, memoryWordCount);
                }
                renderMemoryList();
                updateMemoryEditorMode();
            }

            // --- Settings Management ---
            function saveSettings() {
                localStorage.setItem('apiKey', state.settings.apiKey);
                localStorage.setItem('aiModel', state.settings.aiModel);
            }

            function renderSettingsDisplay() {
                apiKeyInput.value = state.settings.apiKey;
                aiModelSelect.value = state.settings.aiModel;
                apiKeyInput.type = 'password';
                toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
            }
            
            // --- Dropdown Population ---
             function populateAllInputDropdowns() {
                const populate = (selectId, data, placeholder) => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    select.innerHTML = `<option value="">${placeholder}</option>`;
                    [...data].sort((a, b) => b.id - a.id).forEach(item => {
                        select.innerHTML += `<option value="${item.id}">${item.title}</option>`;
                    });
                };
                populate('script-input-script', state.script, 'Chọn từ Đầu vào Ý tưởng...');
                populate('script-input-voice', state.voiceOver, 'Chọn từ Đầu vào VO...');
            }

            // --- API Calls ---
            async function generateAiContent(prompt, submitButton) {
                setButtonLoading(submitButton, true);
                if (!state.settings.apiKey) throw new Error('Vui lòng nhập API Key trong Cài đặt.');
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${state.settings.aiModel}:generateContent?key=${state.settings.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                             contents: [{ parts: [{ text: prompt }] }],
                             generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Lỗi HTTP: ${response.status}`);
                    }
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Không nhận được phản hồi hợp lệ từ AI.");
                    return text;
                } finally {
                    setButtonLoading(submitButton, false);
                }
            }

            async function generatePlainTextAiContent(prompt, submitButton) {
                const originalText = submitButton ? submitButton.textContent : '';
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Đang xử lý...';
                }
                if (!state.settings.apiKey) throw new Error('Vui lòng nhập API Key trong Cài đặt.');
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${state.settings.aiModel}:generateContent?key=${state.settings.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                             contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Lỗi HTTP: ${response.status}`);
                    }
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Không nhận được phản hồi hợp lệ từ AI.");
                    return text.trim();
                } finally {
                    if (submitButton) {
                       submitButton.disabled = false;
                       submitButton.textContent = originalText;
                    }
                }
            }

            async function generateAiImage(prompt) {
                 if (!state.settings.apiKey) throw new Error('Vui lòng nhập API Key trong Cài đặt.');

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${state.settings.apiKey}`;
                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        responseModalities: ['IMAGE']
                    },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Lỗi HTTP: ${response.status}`);
                }

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    throw new Error("Không nhận được dữ liệu ảnh hợp lệ từ AI.");
                }

                return `data:image/png;base64,${base64Data}`;
            }

            
            // --- Main App Rendering ---
            function renderApp() {
                if (state.windows.script) {
                    scriptWindowWrapper.innerHTML = createResultWindowHTML('script', state.windows.script);
                    scriptWindowWrapper.classList.toggle('hidden', state.windows.script.status === 'minimized');
                } else {
                    scriptWindowWrapper.innerHTML = '';
                }

                if (state.windows.vo) {
                    voWindowWrapper.innerHTML = createResultWindowHTML('vo', state.windows.vo);
                    voWindowWrapper.classList.toggle('hidden', state.windows.vo.status === 'minimized');
                } else {
                    voWindowWrapper.innerHTML = '';
                }
                
                if (state.windows.characterPrompts) {
                    characterPromptsWindowWrapper.innerHTML = createPromptListWindowHTML('characterPrompts', state.windows.characterPrompts);
                     characterPromptsWindowWrapper.classList.toggle('hidden', state.windows.characterPrompts.status === 'minimized');
                } else {
                    characterPromptsWindowWrapper.innerHTML = '';
                }

                if (state.windows.scenePrompts) {
                    scenePromptsWindowWrapper.innerHTML = createPromptListWindowHTML('scenePrompts', state.windows.scenePrompts);
                    scenePromptsWindowWrapper.classList.toggle('hidden', state.windows.scenePrompts.status === 'minimized');
                } else {
                    scenePromptsWindowWrapper.innerHTML = '';
                }

                if (state.windows.imageGenerator) {
                    imageGeneratorWindowWrapper.innerHTML = createImageGeneratorWindowHTML('imageGenerator', state.windows.imageGenerator);
                    imageGeneratorWindowWrapper.classList.toggle('hidden', state.windows.imageGenerator.status === 'minimized');
                } else {
                    imageGeneratorWindowWrapper.innerHTML = '';
                }


                taskbarApps.innerHTML = '';
                Object.entries(state.windows).forEach(([type, win]) => {
                    if (win && win.status === 'minimized') {
                        const btn = document.createElement('button');
                        btn.className = 'bg-gray-700 hover:bg-gray-600 text-white text-sm px-3 py-1 rounded-md truncate';
                        btn.textContent = win.title;
                        btn.dataset.windowType = type;
                        taskbarApps.appendChild(btn);
                    }
                });

                saveWindowsState();
            }

            // --- Event Listeners Setup ---
            if (resetMemoryBtn) {
                resetMemoryBtn.addEventListener('click', () => {
                    if (confirm('Bạn có chắc chắn muốn đặt lại toàn bộ bộ nhớ? Tất cả dữ liệu sẽ bị xóa và không thể khôi phục.')) {
                        resetAllMemory();
                    }
                });
            }
            
            scriptDuration.addEventListener('change', (e) => {
                scriptDurationCustom.classList.toggle('hidden', e.target.value !== 'custom');
            });
            
            apiKeyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                state.settings.apiKey = apiKeyInput.value.trim();
                state.settings.aiModel = aiModelSelect.value;
                saveSettings();
                showToast('Đã lưu Cài đặt thành công!', 'success');
                apiKeyContainer.classList.add('hidden');
            });

            toggleApiKeyVisibilityBtn.addEventListener('click', () => {
                const isPassword = apiKeyInput.type === 'password';
                apiKeyInput.type = isPassword ? 'text' : 'password';
                toggleApiKeyVisibilityBtn.innerHTML = isPassword ? eyeOffIconSVG : eyeIconSVG;
            });
            
            toggleListBtn.addEventListener('click', () => {
                const isCollapsed = memoryListColumn.classList.contains('hidden');
                if (isCollapsed) {
                    memoryListColumn.classList.remove('hidden');
                    memoryEditorPanel.classList.replace('w-full', 'w-3/4');
                    toggleListBtn.innerHTML = collapseIconSVG;
                    toggleListBtn.title = "Thu gọn danh sách";
                } else {
                    memoryListColumn.classList.add('hidden');
                    memoryEditorPanel.classList.replace('w-3/4', 'w-full');
                    toggleListBtn.innerHTML = expandIconSVG;
                    toggleListBtn.title = "Mở rộng danh sách";
                    if(memoryEditorPanel.classList.contains('hidden')){
                        memoryEditorPanel.classList.remove('hidden');
                        if (!memoryModalIdInput.value) memoryModalForm.reset();
                    }
                }
            });

            memoryNewItemBtn.addEventListener('click', () => {
                memoryModalForm.reset();
                memoryModalIdInput.value = '';
                updateWordCount(memoryModalContentInput, memoryWordCount);
                
                state.isEditingMemory = true;
                memoryEditorPanel.classList.remove('hidden');
                updateMemoryEditorMode();
                memoryModalTitleInput.focus();
            });

            memoryEditBtn.addEventListener('click', () => {
                state.isEditingMemory = true;
                updateMemoryEditorMode();
                memoryModalContentInput.focus();
            });

            memoryModalList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                const itemDiv = e.target.closest('.script-item');
                if (deleteBtn) {
                    state.itemToDelete = { id: deleteBtn.dataset.id, type: state.currentMemoryType, isPurge: state.currentMemoryType === 'trash' };
                    deleteConfirmMessage.textContent = state.itemToDelete.isPurge
                        ? 'Bạn có chắc chắn muốn xóa vĩnh viễn mục này không? Thao tác này không thể hoàn tác.'
                        : 'Bạn có chắc chắn muốn xóa mục này không? Mục này sẽ được chuyển vào Thùng rác.';
                    deleteConfirmModal.classList.remove('hidden');
                } else if (itemDiv) {
                    memoryEditorPanel.classList.remove('hidden');
                    loadItemIntoMemoryForm(itemDiv.dataset.id);
                }
            });

            memoryModalContentInput.addEventListener('input', () => updateWordCount(memoryModalContentInput, memoryWordCount));

            memoryModalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const type = state.currentMemoryType;
                if (type === 'trash') return showToast('Không thể chỉnh sửa trong thùng rác.', 'error');
                const id = memoryModalIdInput.value;
                const title = memoryModalTitleInput.value.trim();
                const content = memoryModalContentInput.value.trim();
                if (!title || !content) return showToast('Tiêu đề và nội dung không được để trống.', 'error');
                if (id) {
                    const index = state[type].findIndex(i => i.id == id);
                    if (index > -1) state[type][index] = { ...state[type][index], title, content };
                } else {
                    const newItem = { id: Date.now(), title, content };
                    state[type].push(newItem);
                    memoryModalIdInput.value = newItem.id;
                }
                saveDataToStorage(type);
                renderMemoryList();
                state.isEditingMemory = false;
                updateMemoryEditorMode();
                showToast('Đã lưu thành công!', 'success');
            });

            memoryCopyBtn.addEventListener('click', () => {
                const content = memoryModalContentInput.value;
                if (!content) return showToast('Không có nội dung để sao chép.', 'info');
                navigator.clipboard.writeText(content).then(() => showToast('Đã sao chép vào clipboard!', 'success')).catch(() => showToast('Sao chép thất bại!', 'error'));
            });

            memoryExportBtn.addEventListener('click', () => {
                const title = memoryModalTitleInput.value;
                const content = memoryModalContentInput.value;
                if (!content) return showToast('Không có nội dung để xuất file.', 'info');
                downloadAsTxt(title, content);
            });

            cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
            
            deleteAllTrashBtn.addEventListener('click', () => {
                state.itemToDelete = { id: null, type: 'trash', isPurge: true, isDeleteAll: true };
                deleteConfirmMessage.textContent = 'Bạn có chắc chắn muốn xóa vĩnh viễn TẤT CẢ các mục trong thùng rác không? Thao tác này không thể hoàn tác.';
                deleteConfirmModal.classList.remove('hidden');
            });

            deleteAllMemoryBtn.addEventListener('click', () => {
                const type = state.currentMemoryType;
                const config = memoryConfig[type];
                if (!config || type === 'trash') return;

                state.itemToDelete = { id: null, type: type, isPurge: true, isDeleteAll: true };
                deleteConfirmMessage.textContent = `Bạn có chắc chắn muốn xóa vĩnh viễn TẤT CẢ các mục trong "${config.title}" không? Thao tác này không thể hoàn tác.`;
                deleteConfirmModal.classList.remove('hidden');
            });

            confirmDeleteBtn.addEventListener('click', () => {
                if (!state.itemToDelete) return;
                const { id, type, isPurge, isDeleteAll } = state.itemToDelete;
                
                if (isDeleteAll) {
                    if (state.hasOwnProperty(type)) {
                        state[type] = [];
                    }
                } else if (isPurge) {
                    state[type] = state[type].filter(item => item.id != id);
                } else {
                    const itemToMove = state[type].find(item => item.id == id);
                    if (itemToMove) {
                        state.trash.push({ ...itemToMove, originalType: type, deletedAt: new Date().toLocaleString('vi-VN') });
                        saveDataToStorage('trash');
                    }
                    state[type] = state[type].filter(item => item.id != id);
                }
                
                saveDataToStorage(type);

                if (type === state.currentMemoryType) {
                    memoryEditorPanel.classList.add('hidden');
                    renderMemoryList();
                }
                
                state.itemToDelete = null;
                deleteConfirmModal.classList.add('hidden');
                showToast(isDeleteAll ? 'Đã xóa tất cả.' : (isPurge ? 'Đã xóa vĩnh viễn.' : 'Đã chuyển vào thùng rác.'), 'success');
            });
            
            document.querySelectorAll('.close-modal-btn, .cancel-btn').forEach(btn => {
                btn.addEventListener('click', (e) => e.target.closest('.modal-overlay, .workspace-column').classList.add('hidden'));
            });

            scriptForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                               saveUnsavedWindowsToTrash();
                
                const ideaValue = document.getElementById('script-idea').value.trim();
                const selectedScriptId = document.getElementById('script-input-script').value;
                const selectedVoId = document.getElementById('script-input-voice').value;
                const hasCreativeInput = ideaValue || selectedScriptId || selectedVoId;

                if (!state.settings.apiKey) {
                    showToast('Vui lòng nhập API Key trong Cài đặt.', 'error');
                    apiKeyBtn.click();
                    return;
                }
                
                hideMainPanels();
                
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-indicator';
                loadingOverlay.className = 'fixed inset-0 flex justify-center items-center bg-gray-900 bg-opacity-75 z-50';
                loadingOverlay.innerHTML = `<div class="loader" style="width: 40px; height: 40px; border-width: 4px;"></div>`;
                document.body.appendChild(loadingOverlay);

                try {
                    const styleValue = document.getElementById('script-style').value;
                    let durationValue = scriptDuration.value === 'custom' ? scriptDurationCustom.value : scriptDuration.value;
                    const wordLimit = document.getElementById('word-limit').value;
                    const referenceScript = state.script.find(s => s.id == selectedScriptId);
                    const referenceVo = state.voiceOver.find(v => v.id == selectedVoId);

                    const generateCharPrompts = document.getElementById('character-prompt-toggle').checked;
                    const generateScenePrompts = document.getElementById('scene-prompt-toggle').checked;

                    let prompt;
                    let newTitle;

                    let basePrompt = `Bạn là một biên kịch chuyên nghiệp.
Nhiệm vụ: Viết một kịch bản phim và một kịch bản lồng tiếng (voice-over) riêng biệt dựa trên các thông tin được cung cấp.
Yêu cầu định dạng đầu ra: Chỉ trả về một đối tượng JSON hợp lệ, không có văn bản nào khác. Đối tượng JSON phải có hai khóa chính: "main_script" và "voice_over_script".`;

                    if (generateCharPrompts) {
                        basePrompt += `\nThêm một khóa "character_prompts" vào JSON. Giá trị của nó là một mảng các đối tượng, mỗi đối tượng chứa "name" (tên nhân vật) và "prompt" (một prompt mô tả chi tiết ngoại hình, trang phục, biểu cảm của nhân vật đó để tạo ảnh AI).`;
                    }

                    if (generateScenePrompts) {
                        basePrompt += `\nThêm một khóa "scene_prompts" vào JSON. Giá trị của nó là một mảng các đối tượng, mỗi đối tượng chứa "location" (tên bối cảnh) và "prompt" (một prompt mô tả chi tiết bối cảnh đó, không có nhân vật, để tạo ảnh AI).`;
                    }


                    if (hasCreativeInput) {
                        prompt = `${basePrompt}

Sử dụng các thông tin sau:
${ideaValue ? `- Ý tưởng/Yêu cầu chính: ${ideaValue}\n` : ''}
${referenceScript ? `- Kịch bản tham khảo (cốt truyện): --- ${referenceScript.content} ---\n` : ''}
${referenceVo ? `- Lời thoại tham khảo (VO): --- ${referenceVo.content} ---\n` : ''}
${styleValue ? `- Phong cách: ${styleValue}\n` : ''}
- Thời lượng dự kiến: ${durationValue} phút
${wordLimit ? `- Giới hạn tổng số từ khoảng: ${wordLimit} từ` : ''}

Hãy đảm bảo bạn tuân thủ đúng định dạng JSON đã yêu cầu.`;
                        newTitle = `Kịch bản cho: ${(ideaValue || referenceScript?.title || 'dữ liệu vào').substring(0, 30)}...`;
                    } else {
                        prompt = `${basePrompt}

Nhiệm vụ: Hãy sáng tạo ngẫu nhiên một kịch bản phim và một kịch bản lồng tiếng (voice-over) riêng biệt.

Yêu cầu về kịch bản:
${styleValue ? `- Phong cách: ${styleValue}\n` : '- Phong cách: Hãy tự do sáng tạo một phong cách thú vị.\n'}
- Thời lượng dự kiến: ${durationValue} phút
${wordLimit ? `- Giới hạn tổng số từ khoảng: ${wordLimit} từ` : ''}

Hãy đảm bảo bạn tuân thủ đúng định dạng JSON đã yêu cầu.`;
                        newTitle = `Kịch bản ngẫu nhiên (${durationValue} phút)`;
                    }

                    const generatedContent = await generateAiContent(prompt, submitButton);
                    
                    const jsonMatch = generatedContent.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("Phản hồi từ AI không chứa đối tượng JSON hợp lệ.");
                    
                    const result = JSON.parse(jsonMatch[0]);
                    
                    state.windows.script = {
                        title: newTitle,
                        content: formatScriptContent(result.main_script || "AI không tạo được kịch bản chính."),
                        status: 'open', saved: false
                    };
                    state.windows.vo = {
                        title: `VO cho: ${newTitle}`,
                        content: formatScriptContent(result.voice_over_script || "AI không tạo được phần VO riêng biệt."),
                        status: 'open', saved: false
                    };
                    
                    state.windows.scenePrompts = null;
                    if (generateScenePrompts && result.scene_prompts) {
                         state.windows.scenePrompts = {
                            title: 'Prompts Bối cảnh',
                            items: result.scene_prompts,
                            status: 'open'
                        };
                    }

                    state.windows.characterPrompts = null;
                     if (generateCharPrompts && result.character_prompts) {
                         state.windows.characterPrompts = {
                            title: 'Prompts Nhân vật',
                            items: result.character_prompts,
                            status: 'open'
                        };
                    }
                    
                    renderApp();

                } catch (error) {
                    console.error('Lỗi trong quá trình tạo:', error);
                    showToast(`Lỗi: ${error.message}`, 'error');
                } finally {
                    document.getElementById('loading-indicator')?.remove();
                }
            });

            function createResultWindowHTML(type, windowData) {
                const { title, content } = windowData;
                const isScript = type === 'script';
                return `
                <div class="bg-gray-800 rounded-lg flex flex-col h-full shadow-2xl">
                    <div class="flex-shrink-0 bg-gray-700 p-2 flex justify-between items-center rounded-t-lg select-none">
                        <span class="font-bold truncate px-2">${title}</span>
                        <div class="flex space-x-2">
                            <button data-window-type="${type}" class="minimize-btn h-6 w-6 flex items-center justify-center bg-yellow-500 hover:bg-yellow-400 rounded-full text-black font-bold text-lg leading-none pb-1">-</button>
                            <button data-window-type="${type}" class="close-btn h-6 w-6 flex items-center justify-center bg-red-500 hover:bg-red-400 rounded-full text-white font-bold text-lg leading-none pb-1">×</button>
                        </div>
                    </div>
                    <div class="p-4 flex-grow flex flex-col min-h-0">
                        <div class="flex-shrink-0 mb-4">
                            <div class="flex justify-between items-center">
                                <label for="${type}-result-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                                <button data-type="${isScript ? 'mainScripts' : 'mainVoiceOvers'}" class="save-result-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 text-sm rounded-md">Lưu vào ${isScript ? 'S' : 'VO'}</button>
                            </div>
                            <input type="text" id="${type}-result-title" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md" value="${title}">
                        </div>
                        <div class="flex-grow flex flex-col min-h-0">
                            <div class="flex justify-between items-center flex-shrink-0">
                                <label for="${type}-result-content" class="block text-sm font-medium text-gray-300">Nội dung</label>
                                <span id="${type}-word-count" class="text-xs text-gray-400">0 từ</span>
                            </div>
                            <textarea id="${type}-result-content" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md flex-grow">${content}</textarea>
                            <div class="flex justify-between items-center pt-2 flex-shrink-0">
                                <div>
                                    ${isScript 
                                        ? `<a href="https://anproduction2025.github.io/ancontents/S2Se" class="nav-link-dynamic bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 text-sm rounded-md">Chuyển sang S2Se</a>`
                                        : `<a href="#" class="nav-link-dynamic bg-teal-600 hover:bg-teal-500 text-white font-bold py-1 px-3 text-sm rounded-md">Tạo Voice TTS</a>`
                                    }
                                </div>
                                <div class="flex space-x-2">
                                    <button data-type="${type}" class="translate-btn bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold py-1 px-3 text-sm rounded-md">Dịch</button>
                                    <button data-target="${type}-result-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-md">Copy</button>
                                    <button data-target="${type}-result-content" data-title="${type}" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 text-sm rounded-md">Xuất</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            function createPromptListWindowHTML(type, windowData) {
                const { title, items } = windowData;
                const memoryType = type === 'characterPrompts' ? 'characters' : 'scenes';
                const nameLabel = type === 'characterPrompts' ? 'Nhân vật' : 'Bối cảnh';

                let itemsHTML = items && items.length > 0
                    ? items.map((item, index) => {
                        const name = item.name || item.location || 'Không xác định';
                        const prompt = item.prompt || 'N/A';
                        const encodedPrompt = prompt.replace(/"/g, '&quot;');
                        return `
                        <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-teal-400">${nameLabel}: ${name}</h4>
                                <div class="flex space-x-2">
                                    <button data-prompt-content="${encodedPrompt}" class="translate-prompt-item-btn bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-1 rounded text-xs">Dịch</button>
                                    <button data-prompt-content="${encodedPrompt}" class="generate-image-from-prompt-btn bg-pink-600 hover:bg-pink-700 text-white font-bold p-1 rounded text-xs">Tạo ảnh</button>
                                    <button data-prompt-content="${encodedPrompt}" class="copy-prompt-item-btn bg-green-600 hover:bg-green-700 text-white font-bold p-1 rounded text-xs">Copy</button>
                                    <button data-type="${memoryType}" data-name="${name.replace(/"/g, '&quot;')}" data-prompt-content="${encodedPrompt}" class="save-prompt-item-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-1 rounded text-xs">Lưu</button>
                                </div>
                            </div>
                            <p class="prompt-text-content text-sm text-gray-300 bg-gray-800 p-2 rounded">${prompt}</p>
                        </div>
                    `}).join('')
                    : '<p class="text-gray-400 text-center">Không có prompt nào được tạo.</p>';

                return `
                <div class="bg-gray-800 rounded-lg flex flex-col h-full shadow-2xl">
                    <div class="flex-shrink-0 bg-gray-700 p-2 flex justify-between items-center rounded-t-lg select-none">
                        <span class="font-bold truncate px-2">${title}</span>
                        <div class="flex space-x-2">
                            <button data-window-type="${type}" class="minimize-btn h-6 w-6 flex items-center justify-center bg-yellow-500 hover:bg-yellow-400 rounded-full text-black font-bold text-lg leading-none pb-1">-</button>
                            <button data-window-type="${type}" class="close-btn h-6 w-6 flex items-center justify-center bg-red-500 hover:bg-red-400 rounded-full text-white font-bold text-lg leading-none pb-1">×</button>
                        </div>
                    </div>
                    <div class="p-4 flex-grow overflow-y-auto space-y-3">
                       ${itemsHTML}
                    </div>
                </div>
                `;
            }
             function createImageGeneratorWindowHTML(type, windowData) {
                const { title, prompt, imageUrl, isLoading } = windowData;

                const imageAreaHTML = isLoading
                    ? `<div class="w-full h-full flex justify-center items-center bg-gray-900 rounded-lg"><div class="loader" style="width: 40px; height: 40px; border-width: 4px;"></div></div>`
                    : imageUrl
                        ? `<img src="${imageUrl}" class="max-w-full max-h-full object-contain">`
                        : `<div class="w-full h-full flex justify-center items-center bg-gray-900 rounded-lg"><span class="text-gray-500">Ảnh sẽ xuất hiện ở đây</span></div>`;

                return `
                <div class="bg-gray-800 rounded-lg flex flex-col h-full shadow-2xl">
                    <div class="flex-shrink-0 bg-gray-700 p-2 flex justify-between items-center rounded-t-lg select-none">
                        <span class="font-bold truncate px-2">${title}</span>
                        <div class="flex space-x-2">
                            <button data-window-type="${type}" class="minimize-btn h-6 w-6 flex items-center justify-center bg-yellow-500 hover:bg-yellow-400 rounded-full text-black font-bold text-lg leading-none pb-1">-</button>
                            <button data-window-type="${type}" class="close-btn h-6 w-6 flex items-center justify-center bg-red-500 hover:bg-red-400 rounded-full text-white font-bold text-lg leading-none pb-1">×</button>
                        </div>
                    </div>
                    <div class="p-4 flex-grow flex flex-col min-h-0 space-y-4">
                        <div class="flex-grow flex justify-center items-center min-h-0 relative">
                           ${imageAreaHTML}
                        </div>
                        <div class="flex-shrink-0 space-y-2">
                           <textarea id="image-generator-prompt" class="w-full h-24 bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Nhập prompt...">${prompt || ''}</textarea>
                           <button id="generate-image-btn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md flex justify-center items-center" ${isLoading ? 'disabled' : ''}>
                                <span class="btn-text">Tạo ảnh</span>
                                <span class="loader hidden ml-2"></span>
                           </button>
                        </div>
                    </div>
                </div>
                `;
            }

            
            // Centralized event listener for the whole app
            document.body.addEventListener('click', async e => {
                const targetElement = e.target;
                const button = targetElement.closest('button');
                const navLink = targetElement.closest('a');
                const memoryBtn = targetElement.closest('.memory-btn');

                if (button) {
                    const { target, title, type, windowType, promptContent, name } = button.dataset;

                    if (button.id === 'api-key-btn') {
                        saveUnsavedWindowsToTrash();
                        hideAllModals();
                        hideMainPanels();
                        renderSettingsDisplay();
                        apiKeyContainer.classList.remove('hidden');
                        return;
                    }
                     if (button.id === 'create-script-btn' || button.id === 'open-image-studio-btn' || button.id === 'nav-p2s-btn') {
                        saveUnsavedWindowsToTrash();
                        state.windows.characterPrompts = null;
                        state.windows.scenePrompts = null;

                        if (button.id === 'create-script-btn' || button.id === 'nav-p2s-btn') {
                             state.windows.imageGenerator = null;
                             scriptForm.reset();
                             populateAllInputDropdowns();
                             scriptDurationCustom.classList.add('hidden');
                             showWorkspaceColumn(scriptFormContainer);
                        } else {
                            if (!state.windows.imageGenerator) {
                                state.windows.imageGenerator = { title: 'Image Studio', status: 'open', prompt: '', imageUrl: null, isLoading: false };
                            } else {
                                state.windows.imageGenerator.status = 'open';
                            }
                        }
                        renderApp();
                        return;
                    }

                    if (button.id === 'generate-image-btn') {
                        const prompt = document.getElementById('image-generator-prompt').value;
                        if (!prompt) return showToast('Vui lòng nhập prompt.', 'error');

                        state.windows.imageGenerator.isLoading = true;
                        state.windows.imageGenerator.prompt = prompt; // Update state with current prompt
                        renderApp(); // Show loader

                        try {
                            const imageUrl = await generateAiImage(prompt);
                            state.windows.imageGenerator.imageUrl = imageUrl;
                        } catch (error) {
                            showToast(`Lỗi tạo ảnh: ${error.message}`, 'error');
                        } finally {
                            state.windows.imageGenerator.isLoading = false;
                            renderApp(); // Show image or clear loader on error
                        }
                        return;
                    }

                    if (button.classList.contains('translate-btn')) {
                        const contentTextarea = document.getElementById(`${windowType}-result-content`);
                        const textToTranslate = contentTextarea?.value.trim();
                        if (!textToTranslate) return showToast('Không có nội dung để dịch.', 'info');

                        const prompt = `Translate the following Vietnamese text to English. Return only the translated text, without any introductory phrases or markdown formatting:\n\n${textToTranslate}`;
                        
                        generatePlainTextAiContent(prompt, button)
                            .then(translatedText => {
                                contentTextarea.value = translatedText;
                                updateWordCount(contentTextarea, document.getElementById(`${windowType}-word-count`));
                                showToast('Đã dịch thành công!', 'success');
                            })
                            .catch(error => showToast(`Lỗi dịch: ${error.message}`, 'error'));
                        return;
                    }
                     if (button.classList.contains('translate-prompt-item-btn')) {
                        const promptItemDiv = button.closest('.bg-gray-900');
                        const promptElement = promptItemDiv.querySelector('.prompt-text-content');
                        const textToTranslate = promptElement?.textContent.trim();
                        if (!textToTranslate) return showToast('Không có nội dung để dịch.', 'info');

                        const prompt = `Translate the following Vietnamese text into a concise, descriptive English prompt suitable for an AI image generator. Return only the translated prompt, without any introductory phrases or markdown formatting:\n\n${textToTranslate}`;
                        
                        generatePlainTextAiContent(prompt, button)
                            .then(translatedText => {
                                if (promptElement) {
                                    const encodedTranslatedText = translatedText.replace(/"/g, '&quot;');
                                    promptElement.textContent = translatedText;
                                    promptItemDiv.querySelectorAll('button[data-prompt-content]').forEach(btn => {
                                        btn.dataset.promptContent = encodedTranslatedText;
                                    });
                                    showToast('Đã dịch prompt thành công!', 'success');
                                }
                            })
                            .catch(error => showToast(`Lỗi dịch: ${error.message}`, 'error'));
                        return;
                    }
                    
                    if (button.classList.contains('minimize-btn')) {
                        if (state.windows[windowType]) {
                            state.windows[windowType].status = 'minimized';
                            renderApp();
                        }
                    } else if (button.classList.contains('close-btn')) {
                        if (state.windows[windowType]) {
                             if (windowType === 'script' || windowType === 'vo') {
                                const win = state.windows[windowType];
                                if (!win.saved) {
                                    const titleText = document.getElementById(`${windowType}-result-title`)?.value.trim();
                                    const content = document.getElementById(`${windowType}-result-content`)?.value.trim();
                                    if (titleText || content) {
                                        state.trash.push({
                                            id: Date.now() + (windowType === 'vo' ? 1 : 0),
                                            title: `Tự động lưu (Đóng cửa sổ): ${titleText || 'Chưa có tiêu đề'}`,
                                            content: content,
                                            savedAt: new Date().toLocaleString('vi-VN')
                                        });
                                        saveDataToStorage('trash');
                                        showToast('Nội dung chưa lưu đã được chuyển vào Rác.');
                                    }
                                }
                            }
                            state.windows[windowType] = null;
                            renderApp();
                        }
                    } else if (button.closest('#taskbar')) {
                         if (state.windows[windowType]) {
                            state.windows[windowType].status = 'open';
                            renderApp();
                        }
                    } else if (button.classList.contains('copy-btn')) {
                        const content = document.getElementById(target)?.value;
                        if (!content) return showToast('Không có nội dung để sao chép.', 'info');
                        navigator.clipboard.writeText(content).then(() => showToast('Đã sao chép vào clipboard!', 'success')).catch(() => showToast('Sao chép thất bại!', 'error'));
                    } else if (button.classList.contains('copy-prompt-item-btn')) {
                        if (!promptContent) return showToast('Không có nội dung để sao chép.', 'info');
                        navigator.clipboard.writeText(promptContent).then(() => showToast('Đã sao chép prompt!', 'success'));
                    } else if (button.classList.contains('generate-image-from-prompt-btn')) {
                        if (!promptContent) return;
                        state.windows.imageGenerator = { 
                            title: 'Image Studio', 
                            status: 'open', 
                            prompt: promptContent, 
                            imageUrl: null, 
                            isLoading: false 
                        };
                        renderApp();
                    }
                    else if (button.classList.contains('save-prompt-item-btn')) {
                        if (!name || !promptContent) return showToast('Thiếu dữ liệu để lưu.', 'error');
                        state[type].push({ id: Date.now(), title: name, content: promptContent });
                        saveDataToStorage(type);
                        showToast(`Đã lưu "${name}" vào ${memoryConfig[type].title}!`, 'success');
                        button.textContent = 'Đã lưu';
                        button.disabled = true;
                        button.classList.replace('bg-blue-600', 'bg-gray-500');
                    }
                    else if (button.classList.contains('export-btn')) {
                        const content = document.getElementById(target)?.value;
                        const titleText = document.getElementById(`${title}-result-title`)?.value;
                        if (!content) return showToast('Không có nội dung để xuất.', 'info');
                        downloadAsTxt(titleText, content);
                    } else if (button.classList.contains('save-result-btn')) {
                        const isScript = type === 'mainScripts';
                        const titleElemId = isScript ? 'script-result-title' : 'vo-result-title';
                        const contentElemId = isScript ? 'script-result-content' : 'vo-result-content';
                        const titleText = document.getElementById(titleElemId)?.value.trim();
                        const content = document.getElementById(contentElemId)?.value.trim();
                        if (!titleText || !content) return showToast('Cần tiêu đề và nội dung để lưu.', 'error');
                        
                        state[type].push({ id: Date.now(), title: titleText, content });
                        saveDataToStorage(type);
                        
                        if(isScript) { if(state.windows.script) state.windows.script.saved = true; } 
                        else { if(state.windows.vo) state.windows.vo.saved = true; }

                        showToast(`Đã lưu vào ${memoryConfig[type].title}!`, 'success');
                    }
                }
                
                if (memoryBtn) {
                     openMemoryModal(memoryBtn.dataset.type);
                }

                if (navLink) {
                     if (navLink.classList.contains('nav-link-dynamic') || navLink.closest('aside')) {
                        e.preventDefault();
                        saveUnsavedWindowsToTrash();

                        localStorage.removeItem('scriptToProcess');
                        localStorage.removeItem('promptStudioInput');
                        localStorage.removeItem('textToVoice');

                        if (navLink.classList.contains('nav-link-dynamic')) {
                            if (navLink.href.includes('S2Se')) {
                                const content = document.getElementById('script-result-content')?.value;
                                if (content) localStorage.setItem('scriptToProcess', content);
                            }
                             if (navLink.href.includes('text-to-voice')) { // Assuming this is the correct logic now
                                const content = document.getElementById('vo-result-content')?.value;
                                if (content) localStorage.setItem('textToVoice', content);
                            }
                        }
                        
                        window.location.href = navLink.href;
                    }
                }
            });
            
            document.body.addEventListener('input', e => {
                const targetId = e.target.id;
                if (targetId === 'script-result-content' || targetId === 'script-result-title') {
                    if (state.windows.script) state.windows.script.saved = false;
                } else if (targetId === 'vo-result-content' || targetId === 'vo-result-title') {
                    if (state.windows.vo) state.windows.vo.saved = false;
                }

                if (targetId === 'memory-modal-content-input') {
                    updateWordCount(e.target, memoryWordCount);
                }

                const resultWindowTextarea = e.target.closest('textarea[id$="-result-content"]');
                if (resultWindowTextarea) {
                    const type = resultWindowTextarea.id.replace('-result-content', '');
                    const wordCountEl = document.getElementById(`${type}-word-count`);
                    updateWordCount(resultWindowTextarea, wordCountEl);
                }
            });
            
            // --- Sidebar Toggle Logic ---
            const sidebar = document.getElementById('collapsible-sidebar');
            
            sidebar.addEventListener('mouseenter', () => {
                sidebar.classList.replace('w-20', 'w-64');
                 document.querySelectorAll('.sidebar-text').forEach(el => {
                    el.classList.remove('hidden');
                });
            });

            sidebar.addEventListener('mouseleave', () => {
                sidebar.classList.replace('w-64', 'w-20');
                document.querySelectorAll('.sidebar-text').forEach(el => {
                    el.classList.add('hidden');
                });
            });


            // --- Initial Setup ---
            toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
            populateAllInputDropdowns();
            renderApp(); 
            updateMemoryCounters();
             
            // Initial sidebar state
            sidebar.classList.add('w-20');
            sidebar.classList.remove('w-64');
            document.querySelectorAll('.sidebar-text').forEach(el => el.classList.add('hidden'));

        });
    </script>
</body>
</html>
